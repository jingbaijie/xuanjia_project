<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>开学季-趣味成语大赛抽奖页</title>
		<style type="text/css">
			* {
				margin: 0px;
				padding: 0px;
				list-style: none;
			}
			
			#main {
				width: 1280px;
				height: 720px;
				position: relative;
				left: 0px;
				top: 0px;
				background: url(img/lottery/lotteryBG.jpg) no-repeat;
				overflow: hidden;
			}
			
			#hands_x0_y0_lotteryBtnFocus_ img {
				position: absolute;
				left: 555px;
				top: 310px;
			}
			.tipBG{
				position:absolute;
				left:0px;
				top:0px;
				width:1280px;
				height:720px;
				background-color:rgba(0,0,0,0.6);				
			}
		</style>
	</head>

	<body>
		<div id="main">
			<!--抽奖按钮-->
			<div id="hands_x0_y0_lotteryBtnFocus_">
				<img src="img/lottery/lotteryBtnFocus.png" id="lotteryBtnFocus" />
			</div>
			<!--每个奖品对应的位置-->
			<div id="moveLottery">
				<img src="img/lottery/choose.png" class="moveLottery" style="position: absolute;left: 420px;top: 180px;visibility: hidden;" />
				<img src="img/lottery/choose.png" class="moveLottery" style="position: absolute;left: 560px;top: 180px;visibility: hidden;"/>
				<img src="img/lottery/choose.png" class="moveLottery" style="position: absolute;left: 705px;top: 180px;visibility: hidden;"/>
				<img src="img/lottery/choose.png" class="moveLottery" style="position: absolute;left: 705px;top: 320px;visibility: hidden;"/>
				<img src="img/lottery/choose.png" class="moveLottery" style="position: absolute;left: 705px;top: 460px;visibility: hidden;"/>
				<img src="img/lottery/choose.png" class="moveLottery" style="position: absolute;left: 560px;top: 460px;visibility: hidden;"/>
				<img src="img/lottery/choose.png" class="moveLottery" style="position: absolute;left: 420px;top: 460px;visibility: hidden;"/>
				<img src="img/lottery/choose.png" class="moveLottery" style="position: absolute;left: 420px;top: 320px;visibility: hidden;"/>
			</div>

			<!--空选中-->
			<div id="hands_x0_y0_emptyFocus_" style="width: 2px;height: 2px;position: absolute;top: 310px;left: 787px;">
				<img id="emptyFocus" src="img/empty.png" style="width: 2px;height: 2px;visibility: hidden;" alt="">
			</div>
			<!--抽奖中请勿做多余操作-->
			<div id="littleTips" style="position: absolute;left:500px;top:150px;color: red;font-size: 40px;font-weight: bolder;visibility: hidden;">转盘转动中,请勿做多余操作</div>
			<!--弹窗-->
			<div class="tipBG" id="tipBG" style="visibility:hidden;">
				<img src="img/empty.png" id="lotteryTan" style="position: absolute;left: 0px;top: 0px;" />
				<!--二维码图片-->
				<img src="img/empty.png" id="qrCodeImg" style="width: 130px;height: 130px;position: absolute;left: 470px;top: 405px;"/>
			</div>
			<div id="hands_x0_y0_lotteryconfirmFocus_">
				<img src="img/tips/focus.png" id="lotteryconfirmFocus" style="position: absolute;left: 460px;top: 600px;width: 190px;height: 75px;visibility: hidden;" />
			</div>
			<div id="hands_x0_y0_moreExcellentFocus_">
				<img src="img/tips/focus.png" id="moreExcellentFocus" style="position: absolute;left: 652px;top: 600px;width: 190px;height: 75px;visibility: hidden;" />
			</div>			
		</div>
		<!--引入公用JS-->
		<script type="text/javascript" src="../../../../js/loadCommomJs.js"></script>
		<script type="text/javascript" src="../../../../js/actiComm.js?v=2020080401"></script>
		<!--引用结束-->
		<script type="text/javascript">
			/*
			 * 获取奖品列表
			 * 获取当前积分
			 * 抽奖一次，减去积分并存储
			 */

			//焦点数组
			//焦点数组
			var buttons = [{
				id: "hands_x0_y0_lotteryBtnFocus_",
				clickHandler: "javascript:startLottery()",
				left: "disable",
				right: "disable",
				up: "disable",
				down: "disable",
				focusType: 7
			}, {
				id: "hands_x0_y0_emptyFocus_",
				clickHandler: "javascript: notTips()",
				upEvent: "javascript: notTips()",
				downEvent: "javascript: notTips()",
				leftEvent: "javascript: notTips()",
				rightEvent: "javascript: notTips()",
				up: "disable",
				down: "disable",
				left: "disable",
				right: "disable",
				focusType: 7
			}, {
				id: "hands_x0_y0_lotteryconfirmFocus_",
				clickHandler: "javascript: backfunc()",
				up: "disable",
				down: "disable",
				left: "disable",
				right: "hands_x0_y0_moreExcellentFocus_",
				focusType: 7
			}, {
				id: "hands_x0_y0_moreExcellentFocus_",
				clickHandler: "javascript: moreExcellent()",
				up: "disable",
				down: "disable",
				left: "hands_x0_y0_lotteryconfirmFocus_",
				right: "disable",
				focusType: 7
			}]

			
			//用户鉴权结果
			var isOrder = 1;
			//奖品列表
			var prizeList = [];
			//转盘旋转定时器
			var ringInterval = null;

			//奖品ID
			var prizeId = 100;
			//几等奖
			var prizePrice = 100;
			//转盘是否正在转动
			var isRinging = false;

			//抽奖机会
			var creditNum;
			
			var tryData = 0;//userdata存储的信息
			
			//当前奖品数组下标
			var prizeIndex;
			
			//当前用户是否中过奖
			var isPrize = false;
			
			//弹窗是否显示，默认未显示
			var isTipShow = false;
			
			
			orderJs.columnGetAuth(function(data) {
				if (data === "0") {
					isOrder = 0;
				}else {
					isOrder = 1;
				}				
			});
			
			//焦点初始化
			PAGE.focusInit();
			PAGE.changeFocus("hands_x0_y0_lotteryBtnFocus_");
			
			//获取抽奖积分
			actiObj.getUserDataList(function(data){
				if(data && data.errorCode == "1000" && data.successFlg==1){
					tryData=data.data.userActiData.split("_")[1];
					creditNum = data.data.userActiData.split("_")[0];					
				}else{
					creditNum = 0;
				}
			})

			//获取活动奖品列表
			actiObj.getActivityPrize(function(res){
				if(res.errorCode == "1000" && res.data.records.length>0) {
					prizeList = res.data.records;
				} else {
					prizeList = [];
				}
			});
			
			//当前用户获奖信息
			actiObj.getUserPrizeInfo(function(res){
				if(res.errorCode=="1000" && res.data.length>0){
					isPrize = true;//已获奖
				}
			});
			

			//转盘开始旋转
			function startLottery() {
				//转动图片
				var circleImg = 0;

				if(creditNum < 10) {
					CT.$("lotteryTan").src = "img/hebei/noChou.png";
					document.getElementById("tipBG").style.visibility="visible";
					PAGE.changeFocus("hands_x0_y0_lotteryconfirmFocus_");
					isTipShow=true;
				} else {					
					var m = Math.ceil(Math.random() * 2 + 1); //获取[2,3]随机数，三等奖
					var k = Math.ceil(Math.random() * 2 + 3); //获取[4,5]随机数，四等奖
					var n = Math.ceil(Math.random() * 2 +5); //获取[6,7]随机数 ，无奖

					//切换至空焦点
					PAGE.changeFocus("hands_x0_y0_emptyFocus_");
					isRinging = true;

					//每个奖品对应的位置	
					var moveLottery = document.getElementById("moveLottery").getElementsByTagName("img");
					var prizeDeg = [];
					prizeDeg[0] = moveLottery[7];
					prizeDeg[1] = moveLottery[1];
					prizeDeg[2] = moveLottery[0];
					prizeDeg[3] = moveLottery[4];
					prizeDeg[4] = moveLottery[3];
					prizeDeg[5] = moveLottery[6];
					prizeDeg[6] = moveLottery[2];
					prizeDeg[7] = moveLottery[5];					
					
					
					//旋转圈数
					var ringNum = Math.ceil(Math.random() * 10) + 5;		
					//最终旋转位置
					var prizeRingNum = 0;
					//进行概率计算
					var giftPercent = Math.ceil(Math.random() * 1000);
					
					if(prizeList[3].prizeRemainNum > 0 && giftPercent <= prizeList[3].prizePercentage && isOrder==0) {
						//一等奖
						prizeRingNum = prizeDeg[0];
						prizeId = prizeList[3].id;
						prizePrice = prizeList[3].prizePrice;
						prizeIndex = 3;
					} else if(prizeList[2].prizeRemainNum > 0 && giftPercent <= prizeList[3].prizePercentage + prizeList[2].prizePercentage && isOrder==0) {
						//二等奖
						prizeRingNum = prizeDeg[1];
						prizeId = prizeList[2].id;
						prizePrice = prizeList[2].prizePrice;
						prizeIndex = 2;
					} else if(prizeList[1].prizeRemainNum > 0 && giftPercent <= prizeList[3].prizePercentage + prizeList[3].prizePercentage + prizeList[1].prizePercentage && isOrder==0) {
						//三等奖
						prizeRingNum = prizeDeg[m];
						prizeId = prizeList[1].id;
						prizePrice = prizeList[1].prizePrice;
						prizeIndex = 1;
					} else if(prizeList[0].prizeRemainNum > 0 && giftPercent <= prizeList[3].prizePercentage + prizeList[2].prizePercentage + prizeList[1].prizePercentage + prizeList[0].prizePercentage && isOrder==0) {
						//四等奖
						prizeRingNum = prizeDeg[k];
						prizeId = prizeList[0].id;
						prizePrice = prizeList[0].prizePrice;
						prizeIndex = 0;
					} else {
						//无奖品			
						prizeRingNum = prizeDeg[n];
						prizeId = 100;
						prizePrice = 100;
					}

					ringInterval = setInterval(function() {			
						//document.getElementById("errorTip").innerHTML="ringNum:"+ringNum+"<br/>";
						if(ringNum <= 1) {
							prizeRingNum.style.visibility = "visible";
							clearInterval(ringInterval);
							isRinging = false;
							setPrize();
							CT.$("littleTips").style.visibility = "hidden";
						} else {
							//document.getElementById("errorTip").innerHTML+="circleImg:"+circleImg+"<br/>";							
							if(circleImg > 7) {
								ringNum--;
								moveLottery[circleImg - 1].style.visibility = "hidden";
								circleImg = 0;
								if(ringNum != 1) {
									moveLottery[circleImg].style.visibility = "visible";
								}
							} else {									
								moveLottery[circleImg].style.visibility = "visible";									
								if(circleImg >= 1) {
									moveLottery[circleImg - 1].style.visibility = "hidden";									
								}
							}
							circleImg++;
						}
					}, 100);

					//点击立即抽奖，抽奖积分减10
					creditNum-=10;
					//存储抽奖积分
					actiObj.setUserDataList(creditNum+"_"+tryData);
				}
			}

			function setPrize() {
				isRinging = false;
				if(parseInt(prizePrice) <= 4  && !isPrize) {
					actiObj.setPrize(prizeId,function(res){
						if(res.errorCode == "1000" && res.data.flag==1) {
							showPrize();
						} else {
							showConfirm();
						}
					});
				} else {
					showConfirm();
				}
			}

			function showPrize() {
				getQRcode();
				CT.$("lotteryTan").src = "img/hebei/hebeiGetPrizeTip.png";
				PAGE.changeFocus("hands_x0_y0_lotteryconfirmFocus_");
				document.getElementById("tipBG").style.visibility="visible";
				isTipShow=true;
			}

			//未中奖显示
			function showConfirm() {
				PAGE.changeFocus("hands_x0_y0_lotteryconfirmFocus_");
				CT.$("lotteryTan").src = "img/hebei/hebeiPity.png";
				document.getElementById("tipBG").style.visibility="visible";
				isTipShow=true;
			}

			//转盘转动期间禁止多余操作
			function notTips() {
				CT.$("littleTips").style.visibility = "visible";
			}

			//返回
			function backfunc() {
				actiObj.actiCommonJumpUrl("actiTermBeginsMain.html");				
			}

			//回首页
			function moreExcellent(){
				CT.backPage();
			}
			
			function getQRcode() {
				//二维码生成
				var now = new Date();
				var year = now.getFullYear(); //得到年份
				var month = now.getMonth() + 1; //得到月份
				var date = now.getDate(); //得到日期
				var hour = now.getHours(); //得到小时
				var minu = now.getMinutes(); //得到分钟
				var sec = now.getSeconds(); //得到秒
				if(month < 10) month = "0" + month;
				if(date < 10) date = "0" + date;
				if(hour < 10) hour = "0" + hour;
				if(minu < 10) minu = "0" + minu;
				if(sec < 10) sec = "0" + sec;
				var zhongTime = year + "" + month + "" + date + "" + hour + "" + minu + "" + sec;
				var encryption; //加密字符串
				var BossPlatForm = xjDataLog.getPlatform(); //获取平台
				if(BossPlatForm == "HUAWEI") {
					BossPlatForm = "HW";
				} else if(BossPlatForm == "ZTE") {
					BossPlatForm = "ZX";
				} else {
					BossPlatForm = "HW";
				}
				var wxPrizeId;
				if(prizeId == 54 || prizeId==38){
					wxPrizeId = 38;
				}else if(prizeId ==56 || prizeId==40){
					wxPrizeId = 40;
				}else if(prizeId ==58 || prizeId==42){
					wxPrizeId = 42;
				}else if(prizeId ==60 || prizeId==44){
					wxPrizeId = 44;
				}
				//参数加密
				ajax.init({
					url: "http://10.0.2.46:18080/third/thirdpart/encryptParam",
					method: "get",
					params: {
						"appkey": "050ec6cc582c08f4ab8b2f873fdc818a",
						"param": "LT_" + BossPlatForm + "_" + actiUserId + "_xjActivity22_xjPrize"+ wxPrizeId +"_14_" + zhongTime,
						"zx": "14"
					},
					async: true,
					ContentType: "application/x-www-form-urlencoded",
					success: function(res) {
						//console.log(res);
						encryption = res.data;
						CT.$("qrCodeImg").src = "http://10.0.2.46:18080/third/thirdpart/qrcode/acbind2?appkey=050ec6cc582c08f4ab8b2f873fdc818a&param=" + encryption + "&zx=14";
					},
					fail: function(status) {
						console.log("二维码地址请求错误");
					}
				});
			};
			
		</script>
	</body>

</html>